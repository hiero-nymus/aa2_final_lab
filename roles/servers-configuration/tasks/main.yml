---
# tasks file for roles/servers_configuration

- name: Debug hostvars
  debug:
    msg: "{{ hostvars['control'].ansible_default_ipv4.address }}, {{ hostvars['control'].ansible_dns.nameservers.0 }} "

- name: Add DB node to /etc/hosts file
  lineinfile:
    state: present
    path: /etc/hosts
    line: "{{ hostvars[_host].ansible_host }} appdb1"
  loop: "{{ groups['database_servers'] }}"
  loop_control:
    loop_var: _host

- name: Add frontend node to /etc/hosts file
  lineinfile:
    state: present
    path: /etc/hosts
    line: "{{ hostvars[_hahost].ansible_host }} frontend1"
  loop: "{{ groups['load_balancers'] }}"
  loop_control:
    loop_var: _hahost

- name: Add apps node to /etc/hosts file
  lineinfile:
    state: present
    path: /etc/hosts
    line: "{{ hostvars[_appshost].ansible_host }} frontend1{{ loop_index }}"
  loop: "{{ groups['app_servers'] }}"
  loop_control:
    loop_var: _appshost
    index_var: loop_index

- name: Insert DNS IP
  command: >-
    nmcli connection modify "System eth0"
    ipv4.ignore-auto-dns yes
    ipv4.dns {{ hostvars['control'].ansible_default_ipv4.address }}
    +ipv4.dns {{ hostvars['control'].ansible_dns.nameservers.1 }}
    +ipv4.dns 8.8.8.8

- name: Restart NetworkManager
  service:
    name: NetworkManager
    state: restarted

- name: install katello-ca-consumer package
  yum:
    name: http://satellite.example.com/pub/katello-ca-consumer-latest.noarch.rpm
    disable_gpg_check: true
    state: present

- name: register system and attach subs
  redhat_subscription:
    state:   present
    username: "admin"
    password: "r3dh4t1!"
    auto_attach: true
    org_id: "prod"
